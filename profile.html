<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Личный кабинет</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <script>if(localStorage.getItem('theme')==='dark'){document.body.classList.add('dark');}</script>
  <h1>Личный кабинет</h1>
  <div id="info"></div>

  <h2>Подписка</h2>
  <div id="plans">
    <button data-plan="month">1 месяц – 99 ₽</button>
    <button data-plan="quarter">3 месяца – 279 ₽</button>
    <button data-plan="half">6 месяцев – 499 ₽</button>
    <button data-plan="year">12 месяцев – 899 ₽</button>
  </div>

  <h2>Смена пароля</h2>
  <form id="change-password">
    <input type="password" name="old_password" placeholder="Старый пароль" required>
    <input type="password" name="new_password" placeholder="Новый пароль" required>
    <button type="submit">Сменить пароль</button>
  </form>

  <button id="refresh">Обновить токен</button>
  <button id="logout">Выйти</button>
  <button id="delete">Удалить аккаунт</button>

  <script>
    async function loadMe() {
      const token = localStorage.getItem('access_token');
      if (!token) return;

      const res = await fetch('https://api.gluone.ru/auth/web/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('user_data', JSON.stringify(data));
        document.getElementById('info').textContent = JSON.stringify(data);
      } else {
        document.getElementById('info').textContent = 'Не удалось получить данные';
      }
    }
    loadMe();

    document.getElementById('refresh').addEventListener('click', async () => {
      const res = await fetch('https://api.gluone.ru/auth/web/refresh', {
        method: 'POST',
        credentials: 'include'
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('access_token', data.access_token);
        await loadMe();
        alert('Токен обновлен');
      } else {
        alert('Ошибка обновления');
      }
    });

    document.getElementById('logout').addEventListener('click', async () => {
      await fetch('https://api.gluone.ru/auth/web/logout', {
        method: 'POST',
        credentials: 'include'
      });
      localStorage.removeItem('access_token');
      localStorage.removeItem('user_data');
      alert('Вы вышли');
      location.href = 'index.html';
    });

    document.getElementById('delete').addEventListener('click', async () => {
      const username = localStorage.getItem('username');
      const password = prompt('Подтвердите удаление, введя пароль');
      if (!password) return;
      const res = await fetch('https://api.gluone.ru/auth/web/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        localStorage.clear();
        alert('Аккаунт удален');
        location.href = 'index.html';
      } else {
        alert('Ошибка удаления');
      }
    });

    document.getElementById('change-password').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = localStorage.getItem('username');
      const old_password = e.target.old_password.value;
      const new_password = e.target.new_password.value;
      const res = await fetch('https://api.gluone.ru/auth/web/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, old_password, new_password })
      });
      if (res.status === 204) {
        alert('Пароль изменен');
        e.target.reset();
      } else {
        alert('Ошибка смены пароля');
      }
    });

    // ---- Subscription payment ----
    document.querySelectorAll('#plans button').forEach(btn => {
      btn.addEventListener('click', async () => {
        const plan = btn.dataset.plan;
        try {
          const res = await fetch('/api/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan })
          });
          const data = await res.json();
          if (data && data.PaymentURL) {
            window.location.href = data.PaymentURL;
          } else {
            alert('Ошибка оплаты');
          }
        } catch (err) {
          console.error(err);
          alert('Ошибка связи с сервером');
        }
      });
    });
  </script>
</body>
</html>
